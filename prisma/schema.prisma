generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model PrivateClinic {
  id                  String  @id @default(uuid())
  fullName            String
  privatePracticeName String
  phone               String
  email               String  @unique
  password            String
  isPaymentReminderOn Boolean @default(false)
  isPaymentConfirmOn  Boolean @default(false)
  isPlanChangedOn     Boolean @default(false)

  subscriptionPlanId String?
  subscriptionPlan   SubscriptionPlan? @relation(fields: [subscriptionPlanId], references: [id])

  subscriptions Subscription[]
  payments      Payment[]

  invoices         Invoice[]   @relation("ClinicInvoice")
  therapists       Therapist[]
  clients          Client[]
  supportTickets   Support[]   @relation("ClinicSupport")
  stripeCustomerId String?     @unique

  paymentMethods PaymentMethod[] @relation("ClinicPayment")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Therapist {
  id                     String    @id @default(uuid())
  fullName               String
  licenseNumber          String?
  qualification          String?
  email                  String    @unique
  phone                  String
  speciality             String?
  defaultSessionDuration Int?
  timeZone               String?
  availabilityStartTime  DateTime?
  availabilityEndTime    DateTime?
  password               String
  stripeCustomerId       String?   @unique

  clinicId String?
  clinic   PrivateClinic? @relation(fields: [clinicId], references: [id])

  subscriptionPlanId String?
  subscriptionPlan   SubscriptionPlan? @relation(fields: [subscriptionPlanId], references: [id])

  subscriptions Subscription[]
  payments      Payment[]

  paymentMethods PaymentMethod[] @relation("TherapistPayment")
  invoices       Invoice[]       @relation("TherapistInvoice")
  clients        Client[]
  appointments   Appointment[]
  supportTickets Support[]       @relation("TherapistSupport")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Invoice {
  id        String   @id @default(uuid())
  ownerType UserType
  ownerId   String

  clinicId String?
  clinic   PrivateClinic? @relation("ClinicInvoice", fields: [clinicId], references: [id])

  therapistId String?
  therapist   Therapist? @relation("TherapistInvoice", fields: [therapistId], references: [id])

  status    String
  createdAt DateTime @default(now())
}

model Client {
  id              String  @id @default(uuid())
  therapistId     String
  name            String
  email           String
  phone           String
  overallProgress String?
  treatmentGoals  String?
  status          String? @default("active")
  condition       String?

  // Changed to JSON fields for structured data
  healthIssues      Json? // Array of strings: ["Depression", "Anxiety"]
  crisisHistories   Json? // Array of objects: [{ title, date, priority, actionTaken }]
  treatmentProgress Json? // Object: { title, recommendation, percentage }
  sessionHistory    Json? // Array of objects: [{ date, time, note, duration }]

  therapist    Therapist     @relation(fields: [therapistId], references: [id])
  appointments Appointment[]

  privateClinics PrivateClinic[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Appointment {
  id String @id @default(uuid())

  // Relations
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)

  // Scheduling
  scheduledDate DateTime
  scheduledTime String // Stored as "HH:MM" format
  duration      Int      @default(60) // in minutes

  // Session details
  sessionType String @default("virtual") // "virtual" or "onsite"
  phone       String
  email       String

  // Status
  status String @default("scheduled") // "scheduled", "confirmed", "completed", "cancelled", "no-show", "rescheduled"

  // Notes
  notes           String? @db.Text
  completionNotes String? @db.Text

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([therapistId])
  @@index([scheduledDate])
  @@index([status])
  @@map("appointments")
}

model Support {
  id        String   @id @default(uuid())
  ownerType UserType
  ownerId   String

  clinicId String?
  clinic   PrivateClinic? @relation("ClinicSupport", fields: [clinicId], references: [id])

  therapistId String?
  therapist   Therapist? @relation("TherapistSupport", fields: [therapistId], references: [id])

  subject String
  message String @db.Text

  // Status and Reply fields
  status String @default("open") // open, in-progress, resolved, closed

  // Admin response
  adminReply     String?   @db.Text
  adminRepliedAt DateTime?
  adminEmail     String?

  // Resolution
  resolvedAt     DateTime?
  resolutionNote String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
  @@index([ownerType])
  @@index([status])
  @@index([clinicId])
  @@index([therapistId])
  @@map("supports")
}

enum UserType {
  CLINIC
  THERAPIST
}

model PaymentMethod {
  id                    String @id @default(uuid())
  stripePaymentMethodId String @unique
  stripeCustomerId      String

  cardHolderName String
  cardLast4      String @db.VarChar(4)
  cardBrand      String
  expiryMonth    String @db.VarChar(2)
  expiryYear     String @db.VarChar(4)

  billingAddressLine1 String
  billingAddressLine2 String?
  billingCity         String
  billingState        String
  billingPostalCode   String
  billingCountry      String

  isDefault Boolean @default(false)

  clinicId String?
  clinic   PrivateClinic? @relation("ClinicPayment", fields: [clinicId], references: [id], onDelete: Cascade)

  therapistId String?
  therapist   Therapist? @relation("TherapistPayment", fields: [therapistId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clinicId])
  @@index([therapistId])
}

model SubscriptionPlan {
  id       String @id @default(uuid())
  planName String
  price    Float
  duration Int // your custom field
  features String // your custom field

  // Stripe price ID (optional)
  stripePriceId String? @unique

  clinics       PrivateClinic[]
  therapists    Therapist[]
  subscriptions Subscription[]

  createdAt DateTime  @default(now())
  expiredAt DateTime?
  updatedAt DateTime  @updatedAt
}

model Subscription {
  id String @id @default(uuid())

  // Stripe subscription
  stripeSubscriptionId String @unique

  // Plan
  subscriptionPlanId String
  subscriptionPlan   SubscriptionPlan @relation(fields: [subscriptionPlanId], references: [id])

  // Status
  status SubscriptionStatus @default(active)

  // Period
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime

  // Cancellation
  cancelAtPeriodEnd Boolean   @default(false)
  canceledAt        DateTime?

  // Owner: clinic OR therapist
  clinicId String?
  clinic   PrivateClinic? @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  therapistId String?
  therapist   Therapist? @relation(fields: [therapistId], references: [id], onDelete: Cascade)

  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clinicId])
  @@index([therapistId])
}

model Payment {
  id String @id @default(uuid())

  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  stripeSubscriptionId  String
  stripePaymentIntentId String  @unique
  stripeChargeId        String?

  amount      Float
  currency    String        @default("usd")
  status      PaymentStatus @default(pending)
  description String?

  // stored metadata (safe)
  paymentMethodLast4 String
  paymentMethodBrand String
  paymentType        String @default("subscription")

  paidAt DateTime

  clinicId String?
  clinic   PrivateClinic? @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  therapistId String?
  therapist   Therapist? @relation(fields: [therapistId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum SubscriptionStatus {
  active
  canceled
  past_due
  trialing
  incomplete
  incomplete_expired
  unpaid
}

enum PaymentStatus {
  succeeded
  pending
  failed
  canceled
  refunded
}
